#!/bin/bash

function replace { sed -i '' -e "s/@@$1@@/$2/g" "$STAGE/DEBIAN/control"; }

rm -rf "$STAGE"
mkdir -p "$STAGE/$INSTALL_PATH" "$STAGE/DEBIAN"

cp control "$STAGE/DEBIAN"
cp -a versions/$V.* "$STAGE/$INSTALL_PATH"

replace "FULL_VERSION" "$(ls "$STAGE/$INSTALL_PATH" | tail -1)"
replace "VERSION" "$V"
replace "INSTALLED_SIZE" "$(du -I DEBIAN -ks "$STAGE" | cut -f1)"

find "$STAGE" -name ".DS_Store" -exec rm "{}" \;

out="./debs/org.swift.libswift$V.deb"
mkdir -p "debs"
dpkg-deb -Zlzma -b "$STAGE" "$out"

echo "$out" > debs/.latest
rm -rf "$STAGE"
