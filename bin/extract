#!/bin/bash

shopt -s nullglob
set -e

cd versions

for file in *.pkg; do # extracts dylibs from any .pkg files in "versions"
	version="${file##swift-}"
	version="${version%%-*}"
	echo "Extracting toolchain: $version"
	package="${file%.*}-package.pkg"
	xar -xf "$file" "$package/Payload"
	tar -xzf "$package/Payload" "usr/lib/swift/iphoneos/libswift*.dylib"
	mv "usr/lib/swift/iphoneos" "$version"
	rm -rf "$file" "$package" usr
	for dylib in "$version"/*.dylib; do
		install_name_tool -add_rpath "$INSTALL_PATH/$version" "$dylib"
		install_name_tool -id "${INSTALL_PATH%/}/$dylib" "$dylib"
	done
done
